{% extends "base.html" %}

{% block title %}ADM{% endblock %}

{% block extra_head %}
<style>
        .badge-d1, .badge-i1, .badge-c1, .badge-p1 { background-color: #198754; }  /* Vert */
        .badge-d2, .badge-i2, .badge-c2, .badge-p2 { background-color: #ffc107; }  /* Jaune */
        .badge-d3, .badge-i3, .badge-c3, .badge-p3 { background-color: #fd7e14; }  /* Orange */
        .badge-d4, .badge-i4, .badge-c4, .badge-p4 { background-color: #dc3545; }  /* Rouge */
		.badge-criticite1 { background-color: #dc3545; } /* Rouge pour Criticit√© Tr√®s √âlev√©e */
		.badge-criticite2 { background-color: #fd7e14; } /* Orange pour Criticit√© √âlev√©e */
		.badge-criticite3 { background-color: #ffc107; } /* Jaune pour Criticit√© Moyenne */
		.badge-criticite4 { background-color: #198754; } /* Vert pour Criticit√© Faible */
        table {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        th {
            background-color: #0d6efd;
            color: white;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }
    </style>
{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mt-2">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
    <h2 class="text-center text-primary">üìã Catalogue des Applications</h2>
    <div class="d-flex justify-content-between my-3">
        <a href="/add" class="btn btn-primary">‚ûï Ajouter une application</a>
        <a href="/synthese" class="btn btn-outline-primary">üìä Voir Synth√®se</a>
	<a href="/export_csv" class="btn btn-outline-info">üì• Exporter CSV</a>
	<button type="button" class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#reevaluateModal">
        	Tout r√©√©valuer
    	</button>
	<a href="/logout" class="btn btn-outline-secondary">D√©connexion</a>
    </div>

    <table class="table table-bordered text-center">
        <thead>
            <tr>
                <th>Nom</th>
                <th>type</th>
				<th>RDA</th>
				<th>Criticit√©</th>
                <th>Classification (DICP)</th>
                <th>Score</th>
                <th>%</th>
                <th>Risque</th>
                <th>Derni√®re √©valuation</th>
				<th>√âvaluateur</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for app in applications %}
            <tr>
                <td><strong><a href="/resume/{{ app.name }}">{{ app.name }}</a></strong></td>
                <td>{{ app.type }}</td>
                <td>{{ app.rda }}</td>
				<td>
				  {% if app.criticite == "1" %}
					<span class="badge badge-criticite1">Tr√®s √âlev√©e</span>
				  {% elif app.criticite == "2" %}
					<span class="badge badge-criticite2">√âlev√©e</span>
				  {% elif app.criticite == "3" %}
					<span class="badge badge-criticite3">Moyenne</span>
				  {% elif app.criticite == "4" %}
					<span class="badge badge-criticite4">Faible</span>
				  {% else %}
					N/A
				  {% endif %}
				</td>
                <td>
					<div class="d-flex flex-nowrap gap-2">
					<span class="badge badge-{{ app.disponibilite.lower() }}">{{ app.disponibilite }}</span>
                	<span class="badge badge-{{ app.integrite.lower() }}">{{ app.integrite }}</span>
                	<span class="badge badge-{{ app.confidentialite.lower() }}">{{ app.confidentialite }}</span>
                	<span class="badge badge-{{ app.perennite.lower() }}">{{ app.perennite }}</span>
					</div>
				</td>
					
                <td>
			<div class="d-flex flex-nowrap gap-2">
					{% if app.score is none %}
						Non √©valu√©e
					{% else %}
						{{ app.score }}/{{ app.max_score or "N/A" }}
					{% endif %}
			</div>
		</td>
                <td>
                    {% if app.percentage is not none %}
                        <span class="badge {% if app.percentage > 60 %} bg-danger {% elif app.percentage > 30 %} bg-warning {% else %} bg-success {% endif %}">
                            {{ app.percentage }}%
                        </span>
                    {% else %}
                        N/A
                    {% endif %}
                </td>
				<td>
					{% if app.risque is none %}
						Non √©valu√©e
					{% else %}
						{% set risk = app.risque|round(0)|int %}
						{% if risk > 350 %}
							<span class="badge bg-danger">{{ risk }}</span>
						{% elif risk > 100 %}
							<span class="badge bg-warning">{{ risk }}</span>
						{% else %}
							<span class="badge bg-success">{{ risk }}</span>
						{% endif %}
					{% endif %}
				</td>
                <td>{{ app.last_evaluation or "Non √©valu√©e" }}</td>
                <td>{{ app.evaluator_name or "Non √©valu√©e" }}</td>
                <td>
					<div class="d-flex flex-nowrap gap-2">
                    <a href="/score/{{ app.name }}" class="btn btn-sm btn-success" data-bs-toggle="tooltip" title="√âvaluer l'application">‚úÖ</a>
					<button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" title="R√©initialiser l'√©valuation" data-bs-target="#confirmResetModal" data-appname="{{ app.name }}">
						‚ôªÔ∏è
					</button>
					<a href="/edit/{{ app.name }}" class="btn btn-sm btn-secondary" data-bs-toggle="tooltip" title="Modifier l'application">‚úèÔ∏è</a>
					<button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" title="Supprimer l'application" data-bs-target="#confirmDeleteModal" data-appname="{{ app.name }}">
						‚ùå
					</button>
					</div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

	
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- En-t√™te du modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteLabel">Confirmation de suppression</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <!-- Corps du modal -->
      <div class="modal-body">
        √ätes-vous s√ªr de vouloir supprimer l‚Äôapplication <strong><span id="appName"></span></strong> ? Cette action est irr√©versible.
      </div>
      <!-- Pied de page du modal avec les boutons -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <!-- Formulaire de confirmation de suppression -->
        <form id="confirmDeleteForm" method="post" action="">
          <button type="submit" class="btn btn-danger">Supprimer</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmation de r√©initialisation d'√©valuation -->
<div class="modal fade" id="confirmResetModal" tabindex="-1" aria-labelledby="confirmResetLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <!-- En-t√™te du modal -->
      <div class="modal-header">
        <h5 class="modal-title" id="confirmResetLabel">Confirmation de r√©initialisation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <!-- Corps du modal -->
      <div class="modal-body">
        √ätes-vous s√ªr de vouloir r√©initialiser l'√©valuation de l'application <strong><span id="resetAppName"></span></strong> ?<br>
        Cette action remettra √† z√©ro le score, le nombre de questions r√©pondues, l'√©valuateur et la date de la derni√®re √©valuation, sans modifier les r√©ponses et commentaires.
      </div>
      <!-- Pied du modal avec les boutons -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <!-- Formulaire de confirmation de r√©initialisation -->
        <form id="confirmResetForm" method="post" action="">
          <button type="submit" class="btn btn-warning">R√©initialiser</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modale de confirmation -->
<div class="modal fade" id="reevaluateModal" tabindex="-1" aria-labelledby="reevaluateModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reevaluateModalLabel">Confirmation de r√©initialisation des √©valuations</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        √ätes-vous s√ªr de vouloir r√©initialiser l'√©valuation de toutes les applications ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <!-- Le formulaire envoie bien une requ√™te POST -->
        <form action="/reevaluate_all" method="post">
          <button type="submit" class="btn btn-warning">R√©initialiser</button>
        </form>
      </div>
    </div>
  </div>
</div>


<script>
// Cible le modal de confirmation par son ID
var confirmModal = document.getElementById('confirmDeleteModal');
confirmModal.addEventListener('show.bs.modal', function (event) {
    // Bouton qui a d√©clench√© l‚Äôouverture du modal
    var triggerButton = event.relatedTarget;
    // R√©cup√®re le nom de l'application √† supprimer depuis l‚Äôattribut data-appname
    var appName = triggerButton.getAttribute('data-appname');
    // Ins√®re le nom de l'application dans le texte du modal
    var nameSpan = document.getElementById('appName');
    nameSpan.textContent = appName;
    // Met √† jour l'action du formulaire de confirmation pour cibler la bonne application
    var form = document.getElementById('confirmDeleteForm');
    form.action = "/delete/" + appName;
});

var resetModal = document.getElementById('confirmResetModal');
  resetModal.addEventListener('show.bs.modal', function (event) {
    // Bouton d√©clencheur du modal
    var triggerButton = event.relatedTarget;
    var appName = triggerButton.getAttribute('data-appname');
    // Met √† jour le nom affich√© dans le modal
    document.getElementById('resetAppName').textContent = appName;
    // Met √† jour l'action du formulaire pour r√©initialiser la bonne application
    var form = document.getElementById('confirmResetForm');
    form.action = "/reset/" + encodeURIComponent(appName);
  });

  // Initialisation des tooltips Bootstrap
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
  });
</script>

{% endblock %}
