{% extends "base.html" %}
{% block title %}ADM - {{ app.name }}{% endblock %}

{% block extra_head %}
  <style>
    .badge-d1, .badge-i1, .badge-c1, .badge-p1 { background-color: #198754; }
    .badge-d2, .badge-i2, .badge-c2, .badge-p2 { background-color: #ffc107; }
    .badge-d3, .badge-i3, .badge-c3, .badge-p3 { background-color: #fd7e14; }
    .badge-d4, .badge-i4, .badge-c4, .badge-p4 { background-color: #dc3545; }
    .badge-criticite1 { background-color: #dc3545; }
    .badge-criticite2 { background-color: #fd7e14; }
    .badge-criticite3 { background-color: #ffc107; }
    .badge-criticite4 { background-color: #198754; }
    /* Styles pour l'affichage des évaluations */
    .eval-container { margin-top: 30px; }
    .eval-column { padding: 15px; border-radius: 5px; }
    .eval-current { background-color: #ffffff; }
    .eval-previous { background-color: #e9ecef; }
    .eval-header { text-align: center; margin-bottom: 15px; }
    .eval-details p { margin: 5px 0; }
  </style>
{% endblock %}

{% block content %}

  <h2 class="text-center text-primary">Résumé de l'application : {{ app.name }}</h2>
  <div class="mb-3">
    <a href="/" class="btn btn-outline-secondary">Retour à l'index</a>
  </div>
  <!-- Boutons d'action identiques à la page index -->
  <div class="d-flex justify-content-between my-3">
      <a href="/edit/{{ app.name }}" class="btn btn-sm btn-secondary" data-bs-toggle="tooltip" title="Modifier l'application">✏️</a>
      <a href="/score/{{ app.name }}" class="btn btn-sm btn-success" data-bs-toggle="tooltip" title="Évaluer l'application">✅</a>
  </div>
  
  <div class="card mb-3">
    <div class="card-header">
      Détails de l'application
    </div>
    <div class="card-body">
      <p><strong>Nom :</strong> {{ app.name }}</p>
      <p><strong>Type :</strong> {{ app.type }}</p>
      <p><strong>RDA :</strong> {{ app.rda }}</p>
      <p><strong>Date de première possession :</strong> {{ app.possession }}</p>	    
      <p><strong>Criticité :</strong>
        {% if app.criticite == "1" %}
          <span class="badge badge-criticite1">Très Élevée</span>
        {% elif app.criticite == "2" %}
          <span class="badge badge-criticite2">Élevée</span>
        {% elif app.criticite == "3" %}
          <span class="badge badge-criticite3">Moyenne</span>
        {% elif app.criticite == "4" %}
          <span class="badge badge-criticite4">Faible</span>
        {% else %}
          N/A
        {% endif %}
      </p>
      <p><strong>Classification (DICP) :</strong>
        <span class="badge badge-{{ app.disponibilite|lower }}">{{ app.disponibilite }}</span>
        <span class="badge badge-{{ app.integrite|lower }}">{{ app.integrite }}</span>
        <span class="badge badge-{{ app.confidentialite|lower }}">{{ app.confidentialite }}</span>
        <span class="badge badge-{{ app.perennite|lower }}">{{ app.perennite }}</span>
      </p>
      <p><strong>Score :</strong>
        {% if app.score is none %}
          Non évaluée
        {% else %}
          {{ app.score }} / {{ app.answered_questions * 3 }} 
        {% endif %}
      </p>
      <p><strong>Risque :</strong>
        {% if app.risque is not defined or app.risque is none %}
          Non évaluée
        {% else %}
          {% set risk = app.risque|round(0)|int %}
          {% if risk > 500 %}
            <span class="badge bg-danger">{{ risk }}</span>
          {% elif risk > 100 %}
            <span class="badge bg-warning">{{ risk }}</span>
          {% else %}
            <span class="badge bg-success">{{ risk }}</span>
          {% endif %}
        {% endif %}
      </p>
      <p><strong>Pourcentage :</strong>
        {% if app.percentage is not none %}
          {{ app.percentage }}%
        {% else %}
          N/A
        {% endif %}
      </p>
      <p><strong>Dernière évaluation :</strong> {{ app.last_evaluation or "Non évaluée" }}</p>
      <p><strong>Évaluateur :</strong> {{ app.evaluator_name or "Non évaluée" }}</p>
    </div>
  </div>
  
  <!-- Section pour afficher l'historique des évaluations -->
  <div class="eval-container row">
    <div class="col-md-6 eval-column eval-current">
      <div class="eval-header">
        <h4>Évaluation Courante</h4>
      </div>
      <div class="eval-details">
        {% if app.evaluations and app.evaluations|length > 0 %}
          {% set current_eval = app.evaluations[-1] %}
          <p><strong>Score :</strong> {{ current_eval.score }} / {{ current_eval.answered_questions * 3 }} </p>
          <p><strong>Questions répondues :</strong> {{ current_eval.answered_questions }}</p>
          <p><strong>Date :</strong> {{ current_eval.last_evaluation }}</p>
          <p><strong>Évaluateur :</strong> {{ current_eval.evaluator_name }}</p>
        {% else %}
          <p>Aucune évaluation.</p>
        {% endif %}
      </div>
    </div>
    <div class="col-md-6 eval-column eval-previous">
      <div class="eval-header">
        <h4>Évaluation Précédente</h4>
      </div>
      <div class="eval-details">
        {% if app.evaluations and app.evaluations|length > 1 %}
          {% set previous_eval = app.evaluations[-2] %}
          <p><strong>Score :</strong> {{ previous_eval.score }} / {{ previous_eval.answered_questions * 3 }} </p>
          <p><strong>Questions répondues :</strong> {{ previous_eval.answered_questions }}</p>
          <p><strong>Date :</strong> {{ previous_eval.last_evaluation }}</p>
          <p><strong>Évaluateur :</strong> {{ previous_eval.evaluator_name }}</p>
        {% else %}
          <p>Aucune évaluation précédente.</p>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Section Score par Dimension -->
  <div class="card mb-3">
    <div class="card-header">
      Score par Dimension
    </div>
    <div class="card-body">
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Dimension</th>
            <th>Score (somme)</th>
          </tr>
        </thead>
        <tbody>
          {% for dimension, score_sum in category_sums.items() %}
          <tr>
            <td>{{ dimension }}</td>
            <td>{{ score_sum }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Graphique Radar -->
  <div class="card">
    <div class="card-header">
      Graphique Radar
    </div>
    <div class="card-body text-center">
      <img src="data:image/png;base64,{{ radar_chart }}" alt="Radar Chart">
    </div>
  </div>

{% endblock %}
